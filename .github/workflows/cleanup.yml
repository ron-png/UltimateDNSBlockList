name: Cleanup

on:
  schedule:
    - cron: '30 0 * * *' # Run once every day at 00:30
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Remove old entries
        run: |
          if [ -f "do_not_block_temporary" ]; then
            # Calculate cutoff date (3 months ago)
            cutoff_date=$(date -d "3 months ago" +%s)
            
            # Temporary file for valid entries
            touch do_not_block_temporary.tmp
            
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines
              if [ -z "$line" ]; then continue; fi
              
              # Check for example.org
              if echo "$line" | grep -q "||example.org^"; then
                 # Always update example.org to current date
                 echo "||example.org^ # $(date +%Y-%m-%d)" >> do_not_block_temporary.tmp
                 continue
              fi

              # Extract date from line (assumes format: rule # YYYY-MM-DD)
              entry_date_str=$(echo "$line" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}$' || true)
              
              if [ -n "$entry_date_str" ]; then
                # Convert entry date to seconds
                entry_date=$(date -d "$entry_date_str" +%s)
                
                # Check if entry is newer than cutoff
                if [ "$entry_date" -ge "$cutoff_date" ]; then
                  echo "$line" >> do_not_block_temporary.tmp
                else
                  echo "Removing old entry: $line"
                fi
              else
                 # If no date found, add the current date
                 echo "$line # $(date +%Y-%m-%d)" >> do_not_block_temporary.tmp
              fi
            done < do_not_block_temporary
            
            mv do_not_block_temporary.tmp do_not_block_temporary
          fi

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add do_not_block_temporary
          if [[ -n $(git status -s) ]]; then
            git commit -m "Cleanup do_not_block_temporary"
            git push
          else
            echo "No changes to commit"
          fi
