name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  
  # Run every hour
  schedule:
    - cron: '0 * * * *'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    permissions:
      contents: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Download lists, sort and remove duplicates
      - name: Update Blocklist
        run: |
          mkdir -p list
          
          # Increment Version
          if [ ! -f version.txt ]; then echo "0.00" > version.txt; fi
          current_version=$(cat version.txt)
          new_version=$(awk "BEGIN {printf \"%.2f\", $current_version + 0.01}")
          echo $new_version > version.txt

          # Create Header
          echo "! Title: BigBlockList" > header.txt
          echo "! Version: $new_version" >> header.txt
          echo "! Last modified: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> header.txt
          echo "! License: https://github.com/${{ github.repository }}/blob/main/LICENSE" >> header.txt
          while IFS= read -r line || [ -n "$line" ]; do
            if [ -n "$line" ]; then
              echo "! Source: $line" >> header.txt
            fi
          done < sources.txt
          echo "!" >> header.txt

          # Download and Clean
          # Loop through sources.txt, download, and clean each list
          touch combined_temp.txt
          while IFS= read -r url || [ -n "$url" ]; do
            if [ -n "$url" ]; then
              echo "Downloading $url"
              # Download, strip comments (!, #, [), and append to temp file
              curl -s "$url" | grep -v -e "^!" -e "^#" -e "^\[" >> combined_temp.txt
            fi
          done < sources.txt
          
          # Combine
          sort -u combined_temp.txt > combined_unsorted.txt
          
          # Apply Allowlist
          if [ -f "do_not_block_temporary" ]; then
            # Clean allowlist (remove whitespace, empty lines, and dates)
            # Remove comments (dates) starting with #
            sed 's/ *#.*//' do_not_block_temporary | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed '/^$/d' > do_not_block_clean
            grep -vFx -f do_not_block_clean combined_unsorted.txt > combined_cleaned.txt
            rm do_not_block_clean
          else
            mv combined_unsorted.txt combined_cleaned.txt
          fi

          # Add Count to Header
          line_count=$(wc -l < combined_cleaned.txt | xargs)
          echo "! Count: $line_count" >> header.txt
          
          # Final Output
          cat header.txt combined_cleaned.txt > list/bigblocklist.txt
          
          # Cleanup
          rm combined_temp.txt combined_unsorted.txt combined_cleaned.txt header.txt

      # Comit and push changes if there are any
      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add list/bigblocklist.txt version.txt
          if [[ -n $(git status -s) ]]; then
            git commit -m "Update bigblocklist.txt to version $(cat version.txt)"
            git push
          else
            echo "No changes to commit"
          fi
